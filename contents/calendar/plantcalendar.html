<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>植物管理カレンダー</title>

<style>
/* --- 上部コントロールエリア --- */
#controls {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
  padding: 10px;
  border-bottom: 2px solid #ccc;
}

#left-controls,
#center-controls,
#right-controls {
  flex: 1 1 250px;
  margin-bottom: 10px;
}

@media (max-width: 800px) {
  #left-controls,
  #center-controls,
  #right-controls {
    width: 100%;
  }
}

#left-controls { font-size: 16px; }
#center-controls { font-size: 14px; }
#right-controls { font-size: 14px; }

/* --- ボタンエリア --- */
#buttons {
  margin: 10px 0;
  font-size: 14px;
}

/* --- 情報領域（3分割） --- */
#info-area {
  height: 240px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  border-bottom: 2px solid #333;
  padding: 10px;
  margin-bottom: 10px;
}

/* 左カラム：月＋年＋ロゴ */
#info-month {
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  padding-left: 20px;
}

/* ロゴを 2/3 に縮小 */
#info-month .logo {
  font-size: 26px;
  font-weight: bold;
  margin-bottom: 5px;
}

#info-month .month-year {
  display: flex;
  align-items: flex-end;
}

#info-month .month {
  font-size: 120px;
  font-weight: bold;
  line-height: 1;
}

#info-month .year {
  font-size: 40px;
  margin-left: 10px;
  margin-bottom: 10px;
}

/* 中央：季節画像 */
#info-image {
  height: 220px;
  overflow: hidden;
}
#info-image img {
  width: 100%;
  height: 220px;
  object-fit: cover;
}

/* 右：植物情報 */
#info-plants {
  font-size: 14px;
  overflow-y: auto;
  padding: 5px;
  line-height: 1.4;
}

/* --- カレンダー（日付領域） --- */
#calendar {
  width: 100%;
  border-collapse: collapse;
}

#calendar th, #calendar td {
  border: 1px solid #ccc;
  width: 14.2%;
  vertical-align: top;
}

/* 日付数字（2倍）＋ 左余白 */
#calendar td div {
  font-weight: bold;
  margin-bottom: 3px;
  font-size: 30px;
  padding-left: 6px;
}

/* 曜日色 */
#calendar th:nth-child(1) {
  background-color: #ffe5e5;
  color: #d40000;
}
#calendar th:nth-child(7) {
  background-color: #e5f0ff;
  color: #0040c0;
}
#calendar td.sunday div { color: #d40000; }
#calendar td.saturday div { color: #0040c0; }

/* ★ ユーザー設定可能な日付セル高さ */
#calendar textarea {
  width: 100%;
  height: var(--cell-height, 96px);
  border: none;
  resize: none;
  font-size: 12px;
}

/* 印刷最適化 */
@media print {
  #controls, #buttons {
    display: none;
  }

  /* ★ 印刷時だけ高さ倍率を適用（横幅は変わらない） */
  body {
    transform: scaleY(var(--print-scale, 1));
    transform-origin: top left;
  }

  #calendar textarea {
    height: auto;
  }
}
  #calendar td {
  min-height: var(--cell-min-height, 150px);
}


</style>

</head>
<body>

<!-- ========================= -->
<!--  上部コントロールエリア   -->
<!-- ========================= -->
<div id="controls">

  <div class="control-block" id="left-controls">
    <label>年：
      <input type="number" id="year" value="2026">
    </label>
    <br>
    <label>月：
      <select id="month">
        <option value="1">1月</option>
        <option value="2">2月</option>
        <option value="3">3月</option>
        <option value="4">4月</option>
        <option value="5">5月</option>
        <option value="6">6月</option>
        <option value="7">7月</option>
        <option value="8">8月</option>
        <option value="9">9月</option>
        <option value="10">10月</option>
        <option value="11">11月</option>
        <option value="12">12月</option>
      </select>
    </label>
  </div>

  <div class="control-block" id="center-controls">
    <strong>植物選択</strong><br>
    <select id="plant-list" size="6" style="width:200px;"></select>
    <br>
    <button onclick="addPlant()">登録</button>
  </div>

  <div class="control-block" id="right-controls">
    <strong>現在の選択（最大5種類）</strong>
    <ul id="selected-plants"></ul>
  </div>

</div>

<!-- ========================= -->
<!--  作成・印刷ボタン + 調整UI -->
<!-- ========================= -->
<div id="buttons">
  <button onclick="updateAll()">作成</button>
  <button onclick="window.print()">印刷</button>

  <br><br>

  <!-- ★ 日付セル高さ調整 -->
  <label>
    日付セルの高さ：
    <select id="cell-height" onchange="updateCellHeight()">
      <option value="80">80px</option>
      <option value="100">100px</option>
      <option value="120" selected>120px</option>
      <option value="140">140px</option>
      <option value="160">160px</option>
    </select>
  </label>

  <br>

  <!-- ★ 印刷時の高さ倍率 -->
  <label>
    印刷時の高さ倍率：
    <select id="print-scale" onchange="updatePrintScale()">
      <option value="1.00">1.00</option>
      <option value="1.10">1.10</option>
      <option value="1.20">1.20</option>
      <option value="1.30">1.30</option>
      <option value="1.40" selected>1.40</option>
    </select>
  </label>

  <div style="font-size:12px; color:#555; margin-top:4px;">
    ※ 印刷プレビューを見ながら最適な高さと倍率を選んでください
  </div>
</div>

<!-- ========================= -->
<!--  情報領域（3分割）        -->
<!-- ========================= -->
<div id="info-area">

  <div id="info-month">
    <div class="logo">Cultivation Lab</div>
    <div class="month-year">
      <div class="month" id="month-number"></div>
      <div class="year" id="year-number"></div>
    </div>
  </div>

  <div id="info-image"></div>

  <div id="info-plants"></div>

</div>

<!-- ========================= -->
<!--  カレンダー本体           -->
<!-- ========================= -->
<table id="calendar"></table>

<script>
/* ============================
   CSV 読み込み
============================ */
let plantData = [];
let selectedPlants = [];

async function loadPlantCSV() {
  const res = await fetch("/data/plant_tasks.csv");
  const text = await res.text();
  plantData = parseCSV(text);
}

function parseCSV(csvText) {
  const lines = csvText.trim().split("\n");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    return {
      plant: cols[0],
      month: parseInt(cols[1].replace("月", ""), 10),
      task: cols[2],
      note: cols[3] || ""
    };
  });
}

/* ============================
   植物選択 UI
============================ */
function getPlantNames() {
  return [...new Set(plantData.map(d => d.plant))];
}

function renderPlantList() {
  const names = getPlantNames();
  const list = document.getElementById("plant-list");
  list.innerHTML = "";

  names.forEach(name => {
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    list.appendChild(option);
  });
}

function addPlant() {
  const list = document.getElementById("plant-list");
  const plant = list.value;

  if (!plant) return;
  if (selectedPlants.includes(plant)) {
    alert("すでに登録されています");
    return;
  }
  if (selectedPlants.length >= 5) {
    alert("登録できるのは最大5種類です");
    return;
  }

  selectedPlants.push(plant);
  updateSelectedPlantList();
}

function removePlant(name) {
  selectedPlants = selectedPlants.filter(p => p !== name);
  updateSelectedPlantList();
}

function updateSelectedPlantList() {
  const ul = document.getElementById("selected-plants");
  ul.innerHTML = "";

  selectedPlants.forEach(p => {
    ul.innerHTML += `<li>${p} <button onclick="removePlant('${p}')">×</button></li>`;
  });
}

/* ============================
   情報領域の更新
============================ */
function updateInfoArea(month) {
  const year = Number(document.getElementById("year").value);

  document.getElementById("month-number").textContent = month;
  document.getElementById("year-number").textContent = year;

  document.getElementById("info-image").innerHTML =
    `<img src="/images/month/${month}.jpg">`;

  const list = document.getElementById("info-plants");
  list.innerHTML = "";

  const tasks = plantData
    .filter(d => d.month === month && selectedPlants.includes(d.plant))
    .sort((a, b) => a.plant.localeCompare(b.plant));

  tasks.forEach(t => {
    const noteText = t.note ? `、【${t.note}】` : "";
    list.innerHTML += `<div><strong>${t.plant}</strong>：${t.task}${noteText}</div>`;
  });
}

/* ============================
   カレンダー生成
============================ */
function generateCalendar(year, month) {
  const table = document.getElementById("calendar");
  table.innerHTML = "";

  const firstDay = new Date(year, month - 1, 1).getDay();
  const lastDate = new Date(year, month, 0).getDate();

  let row = "<tr>";
  const week = ["日","月","火","水","木","金","土"];
  week.forEach(w => row += `<th>${w}</th>`);
  row += "</tr>";
  table.innerHTML += row;

  row = "<tr>";
  for (let i = 0; i < firstDay; i++) row += "<td></td>";

  for (let d = 1; d <= lastDate; d++) {
    const dayOfWeek = (firstDay + d - 1) % 7;
    const cls =
      dayOfWeek === 0 ? "sunday" :
      dayOfWeek === 6 ? "saturday" : "";

    row += `
      <td class="${cls}">
        <div>${d}</div>
        <textarea></textarea>
      </td>
    `;

    if ((firstDay + d) % 7 === 0) {
      row += "</tr>";
      table.innerHTML += row;
      row = "<tr>";
    }
  }

  row += "</tr>";
  table.innerHTML += row;
}

/* ============================
   印刷調整 UI
============================ */
function updateCellHeight() {
  const h = document.getElementById("cell-height").value;
  document.documentElement.style.setProperty("--cell-height", h + "px");
}

function updatePrintScale() {
  const scale = document.getElementById("print-scale").value;
  document.documentElement.style.setProperty("--print-scale", scale);
}

/* ============================
   updateAll（全更新）
============================ */
async function updateAll() {
  if (plantData.length === 0) {
    await loadPlantCSV();
  }

  const year = Number(document.getElementById("year").value);
  const month = Number(document.getElementById("month").value);

  updateInfoArea(month);
  generateCalendar(year, month);
}

/* ============================
   初期化
============================ */
window.onload = async () => {
  await loadPlantCSV();
  renderPlantList();
  updateCellHeight();
  updatePrintScale();
};
</script>

</body>
</html>
