<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>植物管理カレンダー</title>

<style>
/* --- 上部コントロールエリア --- */
#controls {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 10px;
  padding: 10px;
  border-bottom: 2px solid #ccc;
}

#left-controls {
  width: 40%;
  font-size: 16px;
}

#right-controls {
  width: 55%;
  font-size: 14px;
}

/* --- ボタンエリア --- */
#buttons {
  margin: 10px 0;
}

/* --- 情報領域（3分割） --- */
#info-area {
  height: 240px;
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  border-bottom: 2px solid #333;
  padding: 10px;
  margin-bottom: 10px;
}

#info-month {
  font-size: 80px;
  font-weight: bold;
  text-align: center;
}

#info-image img {
  width: 100%;
  height: 220px;
  object-fit: cover;
}

#info-plants {
  font-size: 14px;
  overflow-y: auto;
  padding: 5px;
}

/* --- カレンダー（日付領域） --- */
#calendar {
  width: 100%;
  border-collapse: collapse;
}

#calendar th, #calendar td {
  border: 1px solid #ccc;
  width: 14.2%;
  vertical-align: top;
}

#calendar textarea {
  width: 100%;
  height: 80px;
  border: none;
  resize: none;
  font-size: 12px;
}

/* --- 印刷時の最適化 --- */
@media print {
  #controls, #buttons {
    display: none;
  }
  #info-area {
    page-break-after: avoid;
  }
}
</style>

</head>
<body>

<!-- ========================= -->
<!--  上部コントロールエリア   -->
<!-- ========================= -->
<div id="controls">

  <!-- 左：年・月選択 -->
  <div id="left-controls">
    <label>年：
      <input type="number" id="year" value="2026">
    </label>
    <br>
    <label>月：
      <select id="month">
        <option value="1">1月</option>
        <option value="2">2月</option>
        <option value="3">3月</option>
        <option value="4">4月</option>
        <option value="5">5月</option>
        <option value="6">6月</option>
        <option value="7">7月</option>
        <option value="8">8月</option>
        <option value="9">9月</option>
        <option value="10">10月</option>
        <option value="11">11月</option>
        <option value="12">12月</option>
      </select>
    </label>
  </div>

  <!-- 右：植物選択 -->
  <div id="right-controls">
    <strong>植物選択（最大5種類）</strong><br>
    <div id="plant-selector"></div>
  </div>

</div>

<!-- 作成・印刷ボタン -->
<div id="buttons">
  <button onclick="updateAll()">作成</button>
  <button onclick="window.print()">印刷</button>
</div>

<!-- ========================= -->
<!--  情報領域（3分割）        -->
<!-- ========================= -->
<div id="info-area">
  <div id="info-month"></div>
  <div id="info-image"></div>
  <div id="info-plants"></div>
</div>

<!-- ========================= -->
<!--  日付領域（カレンダー）   -->
<!-- ========================= -->
<table id="calendar"></table>

<script>
/* ============================
   CSV 読み込み
============================ */
let plantData = [];

async function loadPlantCSV() {
  const res = await fetch("/data/plant_tasks.csv");
  const text = await res.text();
  plantData = parseCSV(text);
}

function parseCSV(csvText) {
  const lines = csvText.trim().split("\n");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    return {
      plant: cols[0],
      month: parseInt(cols[1].replace("月", ""), 10),
      task: cols[2],
      note: cols[3] || ""
    };
  });
}

/* ============================
   植物選択 UI
============================ */
function getPlantNames() {
  return [...new Set(plantData.map(d => d.plant))];
}

function renderPlantSelector(maxSelect = 5) {
  const names = getPlantNames();
  const area = document.getElementById("plant-selector");
  area.innerHTML = "";

  names.forEach(name => {
    area.innerHTML += `
      <label>
        <input type="checkbox" name="plant" value="${name}">
        ${name}
      </label><br>
    `;
  });

  area.addEventListener("change", () => {
    const checked = area.querySelectorAll("input[type=checkbox]:checked");
    if (checked.length > maxSelect) {
      alert(`選択できるのは最大 ${maxSelect} 種類までです`);
      checked[checked.length - 1].checked = false;
    }
  });
}

/* ============================
   情報領域の更新
============================ */
function updateInfoArea(month) {
  document.getElementById("info-month").textContent = month;

  document.getElementById("info-image").innerHTML =
    `<img src="/images/month/${month}.jpg">`;

  const list = document.getElementById("info-plants");
  list.innerHTML = "";

  const selected = [...document.querySelectorAll("input[name=plant]:checked")]
    .map(el => el.value);

  const tasks = plantData.filter(d =>
    d.month === month && selected.includes(d.plant)
  );

  tasks.forEach(t => {
    list.innerHTML += `<div><strong>${t.plant}</strong>：${t.task}</div>`;
  });
}

/* ============================
   カレンダー生成
============================ */
function generateCalendar(year, month) {
  const table = document.getElementById("calendar");
  table.innerHTML = "";

  const firstDay = new Date(year, month - 1, 1).getDay();
  const lastDate = new Date(year, month, 0).getDate();

  let row = "<tr>";
  const week = ["日","月","火","水","木","金","土"];
  week.forEach(w => row += `<th>${w}</th>`);
  row += "</tr>";
  table.innerHTML += row;

  row = "<tr>";
  for (let i = 0; i < firstDay; i++) row += "<td></td>";

  for (let d = 1; d <= lastDate; d++) {
    row += `
      <td>
        <div>${d}</div>
        <textarea></textarea>
      </td>
    `;
    if ((firstDay + d) % 7 === 0) {
      row += "</tr>";
      table.innerHTML += row;
      row = "<tr>";
    }
  }
  row += "</tr>";
  table.innerHTML += row;
}

/* ============================
   updateAll（全更新）
============================ */
async function updateAll() {
  const year = Number(document.getElementById("year").value);
  const month = Number(document.getElementById("month").value);

  if (plantData.length === 0) {
    await loadPlantCSV();
    renderPlantSelector();
  }

  updateInfoArea(month);
  generateCalendar(year, month);
}
</script>

</body>
</html>
