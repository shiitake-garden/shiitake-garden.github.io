<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>セル計算テスト（保存機能付き）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    height: 100vh;
    overflow: hidden;
  }

  header, footer {
    position: fixed;
    left: 0;
    right: 0;
    background: #f5f5f5;
    border-bottom: 1px solid #ccc;
    z-index: 10;
    display: flex;
    align-items: center;
    padding: 0 8px;
  }

  header {
    top: 0;
    height: 10vh;
    justify-content: space-between;
  }

  footer {
    bottom: 0;
    height: 20vh;
    border-top: 1px solid #ccc;
    border-bottom: none;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
  }

  .main {
    position: absolute;
    top: 10vh;
    bottom: 20vh;
    left: 0;
    right: 0;
    overflow-y: auto;
    background: #ffffff;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  thead {
    position: sticky;
    top: 0;
    background: #fafafa;
    z-index: 5;
  }

  th, td {
    border-bottom: 1px solid #eee;
    padding: 4px;
    text-align: center;
    font-size: 14px;
  }

  tr {
    height: 44px;
  }

  input[type="number"] {
    width: 100%;
    height: 32px;
    font-size: 14px;
    text-align: right;
    padding: 0 4px;
  }

  input[readonly] {
    background: #f0f0f0;
    color: #555;
  }

  .btn {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #888;
    background: #fff;
  }

  .info {
    font-size: 12px;
    color: #555;
    text-align: center;
  }

  .base-indicator {
    font-size: 12px;
    color: #333;
  }
</style>
</head>
<body>

<header>
  <div>セル計算テスト</div>
  <button class="btn" onclick="window.print()">印刷</button>
</header>

<div class="main">
  <table id="sheet">
    <thead>
      <tr>
        <th>行</th>
        <th>2列目</th>
        <th>3列目<br>(2+5)</th>
        <th>4列目</th>
        <th>5列目</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<footer>
  <div class="base-indicator" id="baseInfo">基準行：未設定</div>

  <div>
    <button class="btn" onclick="saveData()">保存</button>
    <button class="btn" onclick="loadData()">復元</button>
    <button class="btn" onclick="clearSaved()">保存データ削除</button>
    <button class="btn" onclick="clearInputs()">新規入力</button>
  </div>

  <div class="info">
    ・2列目と5列目の合計が3列目に入り、その行が基準行になります。<br>
    ・基準行より下の4列目に値を入れると「基準行3列目 − 4列目」が5列目に入ります。
  </div>
</footer>

<script>
  const tbody = document.querySelector("#sheet tbody");
  const baseInfo = document.getElementById("baseInfo");
  let baseRowIndex = null;

  const ROW_COUNT = 50;

  // 50行生成
  for (let i = 0; i < ROW_COUNT; i++) {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td><input type="number" inputmode="numeric" class="col2"></td>
      <td><input type="number" class="col3" readonly></td>
      <td><input type="number" inputmode="numeric" class="col4"></td>
      <td><input type="number" inputmode="numeric" class="col5"></td>
    `;

    tbody.appendChild(tr);
  }

  function getRow(rowIndex) {
    const tr = tbody.rows[rowIndex];
    return {
      tr,
      col2: tr.querySelector(".col2"),
      col3: tr.querySelector(".col3"),
      col4: tr.querySelector(".col4"),
      col5: tr.querySelector(".col5"),
    };
  }

  function updateBaseRow(rowIndex) {
    baseRowIndex = rowIndex;
    [...tbody.rows].forEach((tr, i) => {
      const col5 = tr.querySelector(".col5");
      col5.readOnly = (i !== baseRowIndex);
    });
    baseInfo.textContent = "基準行：" + (rowIndex + 1) + " 行目";
  }

  function recalcBaseRow(rowIndex) {
    const { col2, col3, col5 } = getRow(rowIndex);
    const v2 = Number(col2.value) || 0;
    const v5 = Number(col5.value) || 0;
    col3.value = (col2.value || col5.value) ? v2 + v5 : "";
  }

  // 入力イベント設定
  [...tbody.rows].forEach((tr, rowIndex) => {
    const col2 = tr.querySelector(".col2");
    const col3 = tr.querySelector(".col3");
    const col4 = tr.querySelector(".col4");
    const col5 = tr.querySelector(".col5");

    col2.addEventListener("input", () => {
      recalcBaseRow(rowIndex);
      updateBaseRow(rowIndex);
      tr.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    col5.addEventListener("input", () => {
      if (rowIndex === baseRowIndex) recalcBaseRow(rowIndex);
    });

    col4.addEventListener("input", () => {
      if (baseRowIndex === null || rowIndex <= baseRowIndex) return;

      const base = getRow(baseRowIndex);
      const base3 = Number(base.col3.value);
      const v4 = Number(col4.value) || 0;

      col5.value = base3 - v4;
      col5.readOnly = true;

      tr.scrollIntoView({ behavior: "smooth", block: "center" });
    });
  });

  // 保存
  function saveData() {
    const data = [...tbody.rows].map(tr => ({
      col2: tr.querySelector(".col2").value,
      col3: tr.querySelector(".col3").value,
      col4: tr.querySelector(".col4").value,
      col5: tr.querySelector(".col5").value,
    }));

    localStorage.setItem("cellData", JSON.stringify(data));
    localStorage.setItem("baseRowIndex", baseRowIndex);
    alert("保存しました");
  }

  // 復元
  function loadData() {
    const json = localStorage.getItem("cellData");
    if (!json) return;

    const data = JSON.parse(json);
    data.forEach((row, i) => {
      if (!tbody.rows[i]) return;
      const tr = tbody.rows[i];
      tr.querySelector(".col2").value = row.col2;
      tr.querySelector(".col3").value = row.col3;
      tr.querySelector(".col4").value = row.col4;
      tr.querySelector(".col5").value = row.col5;
    });

    const savedBase = localStorage.getItem("baseRowIndex");
    if (savedBase !== null) updateBaseRow(Number(savedBase));
  }

  // 保存データ削除
  function clearSaved() {
    localStorage.removeItem("cellData");
    localStorage.removeItem("baseRowIndex");
    alert("保存データを削除しました");
  }

  // 新規入力（全クリア）
  function clearInputs() {
    [...tbody.rows].forEach(tr => {
      tr.querySelector(".col2").value = "";
      tr.querySelector(".col3").value = "";
      tr.querySelector(".col4").value = "";
      tr.querySelector(".col5").value = "";
    });
    baseRowIndex = null;
    baseInfo.textContent = "基準行：未設定";
  }
</script>

</body>
</html>
