<table id="sheet">
  <tbody>
    <!-- 5行だけ例として -->
    <tr>
      <td>1</td>
      <td><input class="col2"></td>
      <td><input class="col3" readonly></td>
      <td><input class="col4"></td>
      <td><input class="col5"></td>
    </tr>
    <tr>
      <td>2</td>
      <td><input class="col2"></td>
      <td><input class="col3" readonly></td>
      <td><input class="col4"></td>
      <td><input class="col5"></td>
    </tr>
    <!-- 以下同様 -->
  </tbody>
</table>

<script>
let baseRow = null; // 基準行の index

function updateBaseRow(row) {
  baseRow = row;
  // 基準行の5列目は入力可、それ以外は読み取り専用
  document.querySelectorAll("#sheet tr").forEach((tr, i) => {
    const col5 = tr.querySelector(".col5");
    col5.readOnly = (i !== baseRow);
  });
}

document.querySelectorAll("#sheet tr").forEach((tr, rowIndex) => {
  const col2 = tr.querySelector(".col2");
  const col3 = tr.querySelector(".col3");
  const col4 = tr.querySelector(".col4");
  const col5 = tr.querySelector(".col5");

  // 2列目入力 → 新しい基準行
  col2.addEventListener("input", () => {
    const v2 = Number(col2.value) || 0;
    const v5 = Number(col5.value) || 0;
    col3.value = v2 + v5;
    updateBaseRow(rowIndex);
  });

  // 5列目入力 → 基準行の3列目を更新
  col5.addEventListener("input", () => {
    if (rowIndex === baseRow) {
      const v2 = Number(col2.value) || 0;
      const v5 = Number(col5.value) || 0;
      col3.value = v2 + v5;
    }
  });

  // 4列目入力 → 基準行の3列目との差額を5列目へ
  col4.addEventListener("input", () => {
    if (baseRow !== null && rowIndex > baseRow) {
      const baseRowEl = document.querySelectorAll("#sheet tr")[baseRow];
      const base3 = Number(baseRowEl.querySelector(".col3").value) || 0;
      const v4 = Number(col4.value) || 0;
      col5.value = base3 - v4;
    }
  });
});
</script>
