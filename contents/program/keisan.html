<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>スマホ用セル計算テスト</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    height: 100vh;
    overflow: hidden;
  }

  header, footer {
    position: fixed;
    left: 0;
    right: 0;
    background: #f5f5f5;
    border-bottom: 1px solid #ccc;
    z-index: 10;
    display: flex;
    align-items: center;
    padding: 0 8px;
  }

  header {
    top: 0;
    height: 10vh; /* 画面の10% */
    justify-content: space-between;
  }

  footer {
    bottom: 0;
    height: 20vh; /* 画面の20% */
    border-top: 1px solid #ccc;
    border-bottom: none;
    flex-direction: column;
    justify-content: center;
    gap: 8px;
  }

  .main {
    position: absolute;
    top: 10vh;
    bottom: 20vh;
    left: 0;
    right: 0;
    overflow-y: auto;
    background: #ffffff;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  thead {
    position: sticky;
    top: 0;
    background: #fafafa;
    z-index: 5;
  }

  th, td {
    border-bottom: 1px solid #eee;
    padding: 4px;
    text-align: center;
    font-size: 14px;
  }

  tr {
    height: 44px; /* タップしやすい高さ */
  }

  input[type="number"] {
    width: 100%;
    height: 32px;
    font-size: 14px;
    text-align: right;
    padding: 0 4px;
  }

  input[readonly] {
    background: #f0f0f0;
    color: #555;
  }

  .col1 { width: 12%; }
  .col2, .col3, .col4, .col5 { width: 22%; }

  .btn {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 4px;
    border: 1px solid #888;
    background: #fff;
  }

  .info {
    font-size: 12px;
    color: #555;
  }

  .base-indicator {
    font-size: 12px;
    color: #333;
  }
</style>
</head>
<body>

<header>
  <div>セル計算テスト</div>
  <button class="btn" onclick="window.print()">印刷</button>
</header>

<div class="main">
  <table id="sheet">
    <thead>
      <tr>
        <th class="col1">行</th>
        <th class="col2">2列目</th>
        <th class="col3">3列目<br>(2+5)</th>
        <th class="col4">4列目</th>
        <th class="col5">5列目</th>
      </tr>
    </thead>
    <tbody>
      <!-- JSで50行生成 -->
    </tbody>
  </table>
</div>

<footer>
  <div class="base-indicator" id="baseInfo">基準行：未設定</div>
  <div class="info">
    ・2列目と5列目の合計が3列目に入り、その行が基準行になります。<br>
    ・基準行より下の4列目に値を入れると「基準行3列目 − 4列目」が5列目に入ります。
  </div>
</footer>

<script>
  const tbody = document.querySelector("#sheet tbody");
  const baseInfo = document.getElementById("baseInfo");
  let baseRowIndex = null; // 0-based index in tbody rows

  // 50行生成
  const ROW_COUNT = 50;
  for (let i = 0; i < ROW_COUNT; i++) {
    const tr = document.createElement("tr");

    const td1 = document.createElement("td");
    td1.textContent = i + 1;

    const td2 = document.createElement("td");
    const td3 = document.createElement("td");
    const td4 = document.createElement("td");
    const td5 = document.createElement("td");

    const col2 = document.createElement("input");
    col2.type = "number";
    col2.inputMode = "numeric";
    col2.className = "col2";

    const col3 = document.createElement("input");
    col3.type = "number";
    col3.readOnly = true;
    col3.className = "col3";

    const col4 = document.createElement("input");
    col4.type = "number";
    col4.inputMode = "numeric";
    col4.className = "col4";

    const col5 = document.createElement("input");
    col5.type = "number";
    col5.inputMode = "numeric";
    col5.className = "col5";

    td2.appendChild(col2);
    td3.appendChild(col3);
    td4.appendChild(col4);
    td5.appendChild(col5);

    tr.appendChild(td1);
    tr.appendChild(td2);
    tr.appendChild(td3);
    tr.appendChild(td4);
    tr.appendChild(td5);

    tbody.appendChild(tr);
  }

  function getRowElements(rowIndex) {
    const tr = tbody.rows[rowIndex];
    return {
      tr,
      col2: tr.querySelector(".col2"),
      col3: tr.querySelector(".col3"),
      col4: tr.querySelector(".col4"),
      col5: tr.querySelector(".col5"),
    };
  }

  function updateBaseRow(rowIndex) {
    baseRowIndex = rowIndex;
    // 5列目のreadonly制御
    [...tbody.rows].forEach((tr, i) => {
      const col5 = tr.querySelector(".col5");
      if (!col5) return;
      col5.readOnly = (i !== baseRowIndex);
    });
    baseInfo.textContent = "基準行：" + (rowIndex + 1) + " 行目";
  }

  function recalcBaseRow(rowIndex) {
    const { col2, col3, col5 } = getRowElements(rowIndex);
    const v2 = Number(col2.value) || 0;
    const v5 = Number(col5.value) || 0;
    if (col2.value !== "" || col5.value !== "") {
      col3.value = v2 + v5;
    } else {
      col3.value = "";
    }
  }

  // イベント設定
  [...tbody.rows].forEach((tr, rowIndex) => {
    const col2 = tr.querySelector(".col2");
    const col3 = tr.querySelector(".col3");
    const col4 = tr.querySelector(".col4");
    const col5 = tr.querySelector(".col5");

    // 2列目入力 → その行が新たな基準行
    col2.addEventListener("input", () => {
      recalcBaseRow(rowIndex);
      updateBaseRow(rowIndex);
      // 入力欄を中央付近にスクロール
      tr.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    // 5列目入力 → 基準行なら3列目を更新
    col5.addEventListener("input", () => {
      if (rowIndex === baseRowIndex) {
        recalcBaseRow(rowIndex);
      }
    });

    // 4列目入力 → 基準行より下なら差額を5列目へ
    col4.addEventListener("input", () => {
      if (baseRowIndex === null) return;
      if (rowIndex <= baseRowIndex) return;

      const baseRow = getRowElements(baseRowIndex);
      const base3 = Number(baseRow.col3.value);
      if (isNaN(base3)) return;

      const v4 = Number(col4.value) || 0;
      col5.value = base3 - v4;
      // 5列目はこの行では常にreadonly（基準行以外）
      col5.readOnly = true;
      tr.scrollIntoView({ behavior: "smooth", block: "center" });
    });
  });
</script>

</body>
</html>
